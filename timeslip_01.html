<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>警備日報服務報告書</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-size: 16px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Zen Maru Gothic", "Arial", sans-serif;
        background-color: #f8f4ec;
        background-image: url("bg.png");
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        margin: 0;
        padding: 0 16px;
        color: #424242;
      }

      ::-webkit-scrollbar {
        width: 3px;
      }

      /* Handle */
      ::-webkit-scrollbar-thumb {
        background: #bdbdbd;
        border-radius: 10px;
      }

      /* Handle on hover */
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .wrapper {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      .report {
        width: 100%;
        max-width: 390px;
        margin: 0 auto;
        border-radius: 12px;
        box-sizing: border-box;
        overflow: hidden;
        background: transparent;
        clip-path: polygon(
          0 8px,
          3.125% 0,
          6.25% 8px,
          9.375% 0,
          12.5% 8px,
          15.625% 0,
          18.75% 8px,
          21.875% 0,
          25% 8px,
          28.125% 0,
          31.25% 8px,
          34.375% 0,
          37.5% 8px,
          40.625% 0,
          43.75% 8px,
          46.875% 0,
          50% 8px,
          53.125% 0,
          56.25% 8px,
          59.375% 0,
          62.5% 8px,
          65.625% 0,
          68.75% 8px,
          71.875% 0,
          75% 8px,
          78.125% 0,
          81.25% 8px,
          84.375% 0,
          87.5% 8px,
          90.625% 0,
          93.75% 8px,
          96.875% 0,
          100% 8px,
          100% 100%,
          0 100%
        );
      }

      .report-inner {
        padding: 20px 16px;
        position: relative;
        background-color: white;
        background-image: url("data:image/svg+xml,%3Csvg width='75' height='72' viewBox='0 0 75 72' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.14678 13.0021C-1.33287 19.4685 -4.98138 28.234 -4.99993 37.3794C-5.01848 46.5247 -1.40555 55.3049 5.04782 61.7974C12.3219 45.0055 25.2865 30.9793 41.4676 22.6328C27.5006 34.4269 18.0726 50.6976 14.796 68.6623C27.6617 74.737 43.4964 72.5146 54.1353 61.8962C71.3555 44.7092 74.1761 -7 74.1761 -7C74.1761 -7 22.367 -4.18489 5.14678 13.0021Z' fill='%23F3F8E7'/%3E%3C/svg%3E");
        background-position: 0 0;
        background-repeat: no-repeat;
        background-size: 75px 72px;
        padding-top: 20px;
      }

      h1 {
        margin: 0;
        text-align: center;
        font-weight: 700;
        font-size: 20px;
        line-height: 30px;
        margin-bottom: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 0.5rem;
      }

      .double {
        grid-row: span 2;
      }

      .cell {
        background: #e0e0e0;
        padding: 12px;
        border-radius: 8px;
        font-size: 1rem;
        min-width: 48px;
        font-weight: 700;
        min-height: 48px;
        line-height: 1.5rem;
      }

      .cell.big {
        height: 72px;
        overflow-y: auto;
      }

      .cell.right {
        text-align: right;
      }

      .cell.center {
        text-align: center;
        align-content: center;
      }

      .cell.wide {
        grid-column: span 2;
      }

      .cell.time {
        height: 120px;
        grid-row: span 2;
      }

      .cell.people-container {
        max-height: 120px;
        overflow-y: scroll;
        position: relative;
      }

      .cell.shadow {
        box-shadow: 0px 4px 6px 0px #0c0c0d1f inset;
      }

      .people {
        height: auto;
        overflow: visible;
      }

      .people ul {
        margin: 0;
        list-style: none;
      }

      .total {
        position: absolute;
        right: 8px;
        bottom: 8px;
        background: transparent;
        z-index: 1;
        font-weight: 700;
        text-align: right;
      }

      .signature {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 152px;
      }

      .contact {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .button {
        margin-top: 52px;
        margin-left: auto;
        margin-right: auto;
        width: 80px;
        height: 80px;
        border-radius: 16px;
        border: 2px solid #a4cc52;
        background: linear-gradient(180deg, #94c32f 0%, #7eab1f 100%);
        box-shadow: 0px 3px 8px 0px #00000030, 3px 1px 15px 0px #ffffff80 inset,
          0px -3px 10px 0px #0000005e inset;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .button .text {
        color: white;
        font-weight: 700;
        font-size: 10px;
        line-height: 18px;
        letter-spacing: 0%;
      }

      @media (min-width: 480px) {
        .report {
          max-width: 352px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="report"><div class="report-inner">
      <h1>警備日報服務報告書</h1>

      <div class="grid">
        <div class="cell" id="companyName"></div>
        <div class="cell center double" id="fullDate"></div>

        <div class="cell" id="primeOrganization"></div>

        <div class="cell wide" id="constructionSite"></div>

        <div class="cell double people-container">
          <div class="people">
            <div class="total">
              <svg
                width="24"
                height="25"
                viewBox="0 0 24 25"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  fill-rule="evenodd"
                  clip-rule="evenodd"
                  d="M12 11.3203C13.933 11.3203 15.5 9.75331 15.5 7.82031C15.5 5.88732 13.933 4.32031 12 4.32031C10.067 4.32031 8.5 5.88732 8.5 7.82031C8.5 9.75331 10.067 11.3203 12 11.3203ZM12 20.3203C15.3137 20.3203 18 18.7533 18 16.8203C18 14.8873 15.3137 13.3203 12 13.3203C8.68629 13.3203 6 14.8873 6 16.8203C6 18.7533 8.68629 20.3203 12 20.3203ZM7.12205 5.32031C7.29951 5.32031 7.47276 5.33772 7.64005 5.37088C7.23249 6.09477 7 6.93039 7 7.82031C7 8.68857 7.22131 9.50513 7.61059 10.2167C7.45245 10.2461 7.28912 10.2616 7.12205 10.2616C5.70763 10.2616 4.56102 9.15544 4.56102 7.79094C4.56102 6.42645 5.70763 5.32031 7.12205 5.32031ZM5.44734 19.3063C4.87942 18.6274 4.5 17.7943 4.5 16.8203C4.5 15.8761 4.85657 15.0643 5.39578 14.397C3.4911 14.5448 2 15.5865 2 16.8497C2 18.1247 3.5173 19.1741 5.44734 19.3063ZM16.3888 10.2167C16.7781 9.50513 16.9994 8.68857 16.9994 7.82031C16.9994 6.93039 16.7669 6.09477 16.3594 5.37088C16.5267 5.33772 16.6999 5.32031 16.8774 5.32031C18.2918 5.32031 19.4384 6.42645 19.4384 7.79094C19.4384 9.15544 18.2918 10.2616 16.8774 10.2616C16.7103 10.2616 16.547 10.2461 16.3888 10.2167ZM21.9994 16.8497C21.9994 18.1247 20.4821 19.1741 18.5521 19.3063C19.12 18.6274 19.4994 17.7943 19.4994 16.8203C19.4994 15.8761 19.1429 15.0643 18.6036 14.397C20.5083 14.5448 21.9994 15.5865 21.9994 16.8497Z"
                  fill="#424242"
                />
              </svg>
              <br />
              計 <span id="workerCount"></span> 名
            </div>

            <ul id="workerList"></ul>
          </div>
        </div>
        <div class="cell time center" id="workingTime"></div>
        <div class="cell shadow big" id="creatorNote"></div>
        <div class="cell double signature">
          <img id="signatureImage" style="max-height: 100%" />
        </div>
        <div class="cell shadow big" id="signerNote"></div>
      </div></div>
      </div>
      <button class="button">
      <svg
        width="81"
        height="80"
        viewBox="0 0 81 80"
        fill="none"
        style="position: absolute"
        xmlns="http://www.w3.org/2000/svg"
      >
        <g clip-path="url(#clip0_4333_238)">
          <path
            d="M4.11357 58.1157C1.16738 61.0626 -0.491534 65.0574 -0.499968 69.2253C-0.508401 73.3931 1.13433 77.3946 4.06857 80.3534C7.37596 72.7008 13.2708 66.3085 20.628 62.5047C14.2775 67.8797 9.99073 75.2948 8.50092 83.482C14.3507 86.2505 21.5505 85.2376 26.3878 80.3984C34.2175 72.5657 35.5 49 35.5 49C35.5 49 11.9433 50.2829 4.11357 58.1157Z"
            fill="white"
            fill-opacity="0.1"
          />
        </g>
        <defs>
          <clipPath id="clip0_4333_238">
            <rect
              width="80"
              height="80"
              fill="white"
              transform="translate(0.5)"
            />
          </clipPath>
        </defs>
      </svg>
      <svg
        width="33"
        height="32"
        viewBox="0 0 33 32"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M17.8337 4.00033C17.8337 3.26395 17.2367 2.66699 16.5003 2.66699C15.764 2.66699 15.167 3.26395 15.167 4.00033V17.8993L12.151 14.6006C11.6542 14.0572 10.8108 14.0194 10.2673 14.5163C9.72384 15.0132 9.68608 15.8565 10.183 16.4L15.5163 22.2334C15.7689 22.5096 16.126 22.667 16.5003 22.667C16.8747 22.667 17.2318 22.5096 17.4844 22.2334L22.8177 16.4C23.3146 15.8565 23.2768 15.0132 22.7334 14.5163C22.1899 14.0194 21.3465 14.0572 20.8496 14.6006L17.8337 17.8993V4.00033ZM5.83366 20.0003C5.83366 19.2639 5.23671 18.667 4.50033 18.667C3.76395 18.667 3.167 19.2639 3.167 20.0003L3.16699 20.0944C3.16695 21.8999 3.16691 23.3887 3.32533 24.567C3.49166 25.8041 3.85428 26.8967 4.72908 27.7715C5.60389 28.6464 6.69646 29.009 7.93357 29.1753C9.11191 29.3337 10.6007 29.3337 12.4062 29.3337H12.4062H20.5944H20.5944C22.3999 29.3337 23.8887 29.3337 25.067 29.1753C26.3042 29.009 27.3967 28.6464 28.2715 27.7715C29.1464 26.8967 29.509 25.8042 29.6753 24.567C29.8338 23.3887 29.8337 21.8999 29.8337 20.0944V20.0003C29.8337 19.2639 29.2367 18.667 28.5003 18.667C27.764 18.667 27.167 19.2639 27.167 20.0003C27.167 21.9236 27.1642 23.232 27.0324 24.2117C26.9059 25.1531 26.6827 25.5891 26.3859 25.8859C26.0891 26.1827 25.6531 26.4059 24.7117 26.5324C23.732 26.6642 22.4236 26.667 20.5003 26.667H12.5003C10.577 26.667 9.26867 26.6642 8.28891 26.5324C7.34751 26.4059 6.91148 26.1827 6.61472 25.8859C6.31795 25.5891 6.09479 25.1531 5.96822 24.2117C5.83649 23.232 5.83366 21.9236 5.83366 20.0003Z"
          fill="white"
        />
      </svg>
      <span class="text">ダウンロード</span>
      </button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      let currentId = null;
      function formatHHmm(time) {
        if (time == null) return "";
        const parts = String(time).split(":");
        const hh = (parts[0] || "00").padStart(2, "0");
        const mm = (parts[1] || "00").padStart(2, "0");
        return `${hh}:${mm}`;
      }
      async function renderTimeslip() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        currentId = id;

        if (!id) return alert("❌ URLが正しくありません");

        try {
          const endpoint =
            "https://security.ecopunch.vn/api/v1/public/timeslips";
          const res = await fetch(`${endpoint}?id=${id}`);
          const json = await res.json();
          const data = json.data;

          if (!data || json.code !== "OK") throw new Error("Invalid data");

          const date = new Date(data.workDate);
          const fullDate = `${date.getFullYear()}年${
            date.getMonth() + 1
          }月<br />${date.getDate()}日`;
          document.getElementById("fullDate").innerHTML = fullDate;

          document.getElementById("companyName").innerText =
            data.prime?.name || "";
          document.getElementById("primeOrganization").innerText =
            data.primeOrganization?.name || "";
          document.getElementById("constructionSite").innerText =
            data.construction?.name || "";

          const moonIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21C16.9706 21 21 16.9706 21 12C21 11.5836 20.3759 11.5148 20.1605 11.8712C19.1361 13.5666 17.2754 14.7 15.15 14.7C11.9191 14.7 9.3 12.0809 9.3 8.85C9.3 6.72461 10.4334 4.86395 12.1288 3.83948C12.4852 3.62412 12.4164 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" fill="#424242"/></svg>`;
          const sunIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5814 12C17.5814 15.0825 15.0825 17.5814 12 17.5814C8.91749 17.5814 6.4186 15.0825 6.4186 12C6.4186 8.91749 8.91749 6.4186 12 6.4186C15.0825 6.4186 17.5814 8.91749 17.5814 12Z" fill="currentColor"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12 0C12.4624 0 12.8372 0.374835 12.8372 0.837209V3.06977C12.8372 3.53214 12.4624 3.90698 12 3.90698C11.5376 3.90698 11.1628 3.53214 11.1628 3.06977V0.837209C11.1628 0.374835 11.5376 0 12 0ZM2.69989 2.75284C3.01189 2.4116 3.54145 2.38789 3.8827 2.69989L6.36308 4.96771C6.70433 5.27971 6.72804 5.80926 6.41604 6.15051C6.10404 6.49175 5.57447 6.51546 5.23323 6.20346L2.75284 3.93565C2.4116 3.62365 2.38789 3.09409 2.69989 2.75284ZM21.3002 2.75284C21.6122 3.09409 21.5884 3.62365 21.2471 3.93565L18.7668 6.20346C18.4255 6.51546 17.896 6.49175 17.584 6.15051C17.272 5.80926 17.2956 5.27971 17.6369 4.96771L20.1174 2.69989C20.4586 2.38789 20.9881 2.4116 21.3002 2.75284ZM0 12C0 11.5376 0.374835 11.1628 0.837209 11.1628H3.06977C3.53214 11.1628 3.90698 11.5376 3.90698 12C3.90698 12.4624 3.53214 12.8372 3.06977 12.8372H0.837209C0.374835 12.8372 0 12.4624 0 12ZM20.093 12C20.093 11.5376 20.4679 11.1628 20.9302 11.1628H23.1628C23.6252 11.1628 24 11.5376 24 12C24 12.4624 23.6252 12.8372 23.1628 12.8372H20.9302C20.4679 12.8372 20.093 12.4624 20.093 12ZM17.6099 17.6095C17.9368 17.2826 18.4669 17.2826 18.7939 17.6095L21.2743 20.0902C21.6012 20.4172 21.6011 20.9473 21.2742 21.2743C20.9472 21.6012 20.4171 21.6011 20.0902 21.2742L17.6099 18.7935C17.2829 18.4665 17.2829 17.9365 17.6099 17.6095ZM6.39033 17.6096C6.71728 17.9366 6.71728 18.4667 6.39033 18.7937L3.9097 21.2743C3.58275 21.6012 3.05267 21.6012 2.72571 21.2743C2.39876 20.9473 2.39876 20.4172 2.72571 20.0903L5.20634 17.6096C5.53328 17.2827 6.06337 17.2827 6.39033 17.6096ZM12 20.093C12.4624 20.093 12.8372 20.4679 12.8372 20.9302V23.1628C12.8372 23.6252 12.4624 24 12 24C11.5376 24 11.1628 23.6252 11.1628 23.1628V20.9302C11.1628 20.4679 11.5376 20.093 12 20.093Z" fill="currentColor"/></svg>`;
          const icon = data.timeType === "NIGHT" ? moonIcon : sunIcon;
          document.getElementById("workingTime").innerHTML = `${formatHHmm(data.startTime)} ~ ${formatHHmm(data.endTime)}<div style="margin-top:8px;display:flex;justify-content:center">${icon}</div><div style=\"margin-top:8px\">(休${data.breakTime}分)</div>`;
          document.getElementById("creatorNote").innerText =
            data.createdNote || "";
          document.getElementById("signerNote").innerText =
            data.signerNote || "";
          document.getElementById("workerCount").innerText = data.users.length;

          const ul = document.getElementById("workerList");
          ul.innerHTML = "";
          data.users.forEach((user) => {
            const li = document.createElement("li");
            li.innerText = `${user.userCode} ${user.name}`;
            ul.appendChild(li);
          });

          if (data.sign) {
            document.getElementById(
              "signatureImage"
            ).src = `data:image/png;base64,${data.sign}`;
          }

          const orgNames = (data.organizations || [])
            .map((o) => o.name)
            .join("/");
          const primeOrgNames = (data.primeOrganizations || [])
            .map((o) => o.name)
            .join("/");
          document.getElementById("organizationNames").innerText =
            orgNames.length > 50 ? orgNames.slice(0, 50) + "..." : orgNames;
          document.getElementById("primeOrganizationNames").innerText =
            primeOrgNames.length > 50
              ? primeOrgNames.slice(0, 50) + "..."
              : primeOrgNames;
        } catch (err) {
          console.error(err);
          alert("❌ データ取得エラー");
        }
      }
      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const element = document.body;

        const canvas = await html2canvas(element, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const ratio = Math.min(
          pageWidth / canvas.width,
          pageHeight / canvas.height
        );

        const imgWidth = canvas.width * ratio;
        const imgHeight = canvas.height * ratio;

        doc.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
        const filename = currentId ? `${currentId}.pdf` : "keibi-report.pdf";
        doc.save(filename);
      }

      document.querySelector(".button").addEventListener("click", exportPDF);

      renderTimeslip();
    </script>
  </body>
</html>
